# Практична робота 2: Telegram Бот для підбору систем відеоспостереження

## Опис проекту

Це практична робота з розробки Telegram-бота з використанням бібліотеки Aiogram 3.0, 
інтегрованою базою даних SQLite та імітованою системою оплати.

## Функціонал

### Telegram Бот (@PidbirCamer_bot)

**Основні команди:**
- `/start` - Початок роботи з ботом
- `/help` - Довідка про команди
- `/register` - Реєстрація користувача
- `/balance` - Перевірка балансу
- `/topup` - Поповнення балансу (імітація)
- `/catalog` - Перегляд каталогу систем
- `/orders` - Історія замовлень
- `/info` - Інформація про бота

**Функції:**
1. **Підбір системи за параметрами** - Бот задає питання про:
   - Кількість камер
   - Площу покриття
   - Бюджет
   
2. **Перегляд каталогу** - Показує всі доступні системи з цінами

3. **Оформлення замовлення**:
   - Перевірка балансу
   - Запит номера телефону
   - Підтвердження замовлення
   - Списання коштів
   - Збереження в базу даних

4. **Історія замовлень** - Показує всі попередні покупки

5. **Система балансів** - Імітація платіжної системи з різними сумами поповнення

### Веб-додаток (Flask)

**Доступний на:** http://127.0.0.1:5000

**Сторінки:**
- `/` - Головна сторінка з інформацією про послуги
- `/about` - Про додаток та технології
- `/tasks` - Система управління завданнями (To-Do List)
- `/login` - Вхід
- `/register` - Реєстрація

**Функції:**
1. **Аутентифікація** - Реєстрація та вхід користувачів
2. **CRUD для завдань**:
   - Створення завдань
   - Перегляд завдань (доступний для всіх)
   - Редагування завдань (тільки для авторизованих)
   - Видалення завдань (тільки для авторизованих)

### База даних (SQLite)

**Таблиці:**
- `users` - Користувачі (tg_id, name, balance, phone)
- `security_systems` - Системи відеоспостереження (name, cameras, area, price, features)
- `orders` - Замовлення (user_tg_id, system_id, phone, total_price, status, created_at)
- `tasks` - Завдання для веб-додатку (title, description, owner_tg)

## Структура проекту

```
/app/
├── bot.py                  # Головний файл Telegram бота
├── config.py               # Конфігурація (токени, URL бази даних)
├── webapp.py               # Flask веб-додаток
├── requirements.txt        # Залежності Python
├── db.sqlite3             # База даних SQLite
├── app/
│   ├── __init__.py
│   ├── handlers.py        # Обробники команд та callback'ів бота
│   ├── keyboards.py       # Клавіатури для бота
│   ├── payment.py         # Логіка імітації платежів
│   └── database/
│       ├── models.py      # Моделі SQLAlchemy
│       └── requests.py    # Запити до бази даних
├── templates/             # HTML шаблони для Flask
│   ├── base.html
│   ├── home.html
│   ├── about.html
│   ├── login.html
│   ├── register.html
│   ├── tasks.html
│   └── task_edit.html
└── static/
    └── css/
        └── style.css      # Кастомні стилі
```

## Технології

**Backend:**
- Python 3.11+
- Aiogram 3.10.0 - Telegram Bot framework
- Flask 3.0.0 - Web framework
- SQLAlchemy 2.0.21 - ORM
- aiosqlite 0.19.0 - Async SQLite driver

**Frontend:**
- HTML5
- CSS3
- Bootstrap 5.3.0
- Bootstrap Icons 1.11.1

## Встановлення та запуск

### 1. Встановлення залежностей
```bash
pip install -r requirements.txt
```

### 2. Налаштування
Відредагуйте `config.py`:
```python
BOT_TOKEN = "ваш_токен_від_BotFather"
DATABASE_URL = "sqlite+aiosqlite:///./db.sqlite3"
PAYMENT_TOKEN = "SIMULATED"  # для імітації
```

### 3. Запуск через Supervisor (рекомендовано)
```bash
sudo supervisorctl reread
sudo supervisorctl update
sudo supervisorctl status
```

### 4. Ручний запуск

**Telegram бот:**
```bash
python bot.py
```

**Веб-додаток:**
```bash
python webapp.py
```

Веб-додаток буде доступний на http://127.0.0.1:5000

## Особливості реалізації

### Імітація оплати
Система оплати є імітованою для навчальних цілей:
- Користувач вибирає суму для поповнення (50$, 100$, 200$, 500$)
- Натискає кнопку "Імітувати оплату"
- Баланс одразу поповнюється
- Реальної інтеграції з платіжними системами немає

### FSM (Finite State Machine)
Використовується для багатокрокових діалогів:
- `CatalogSearch` - Підбір системи (камери → площа → бюджет)
- `OrderProcess` - Оформлення замовлення (телефон → підтвердження)

### Асинхронність
- Telegram бот повністю асинхронний (async/await)
- База даних використовує aiosqlite для асинхронних запитів
- Веб-додаток використовує `asyncio.run()` для виконання async функцій

### Безпека
⚠️ **Увага:** Це навчальний проект!
- Паролі хешуються за допомогою werkzeug.security
- Для production потрібно:
  - Зберігати користувачів в БД, а не в пам'яті
  - Використовувати HTTPS
  - Додати CSRF захист
  - Використовувати секретні ключі з environment variables

## Тестування

### Тестування бота
1. Знайдіть бота в Telegram: @PidbirCamer_bot
2. Відправте `/start`
3. Спробуйте команди:
   - Зареєструйтесь через `/register`
   - Поповніть баланс через кнопку "Поповнити баланс"
   - Перегляньте каталог через кнопку "Каталог"
   - Оформіть замовлення на систему
   - Перегляньте історію через "Мої замовлення"

### Тестування веб-додатку
1. Відкрийте http://127.0.0.1:5000
2. Зареєструйтесь через /register
3. Увійдіть через /login
4. Додайте кілька завдань на сторінці /tasks
5. Спробуйте редагувати та видаляти завдання

## Логи

Логи supervisor:
```bash
tail -f /var/log/supervisor/telegram_bot.out.log
tail -f /var/log/supervisor/telegram_bot.err.log
tail -f /var/log/supervisor/webapp.out.log
tail -f /var/log/supervisor/webapp.err.log
```

## Автор

Практична робота 2 - 2025
Тема: Розробка чат-ботів на Python з використанням бібліотеки Aiogram 3.0

## Примітки

- База даних створюється автоматично при першому запуску
- Початкові дані для систем відеоспостереження завантажуються через `seed_systems()`
- Бот токен вказаний в config.py (замініть на свій для production)
- Для production використовуйте production WSGI сервер (gunicorn, uwsgi) замість Flask development server
