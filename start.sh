#!/bin/bash

# –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–æ–¥—É–≤–∞–Ω–Ω—è UTF-8
export LANG=ru_RU.UTF-8
export LC_ALL=ru_RU.UTF-8

echo "========================================"
echo "      SecureVision - –ó–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º–∏"
echo "========================================"
echo ""

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ Python
if ! command -v python3 &> /dev/null; then
    echo "‚ùå Python3 –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ! –í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å Python 3.8+"
    exit 1
fi

echo "‚úÖ Python3 –∑–Ω–∞–π–¥–µ–Ω–æ: $(python3 --version)"
echo ""

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ç–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞
if [ ! -d "venv" ]; then
    echo "üì¶ –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞..."
    python3 -m venv venv
    echo "‚úÖ –í—ñ—Ä—Ç—É–∞–ª—å–Ω–µ —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ —Å—Ç–≤–æ—Ä–µ–Ω–æ"
fi

echo "üîß –ê–∫—Ç–∏–≤–∞—Ü—ñ—è –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞..."
source venv/bin/activate

echo "üì¶ –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è/–æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π..."
pip install -r requirements.txt --quiet
if [ $? -ne 0 ]; then
    echo "‚ùå –ü–æ–º–∏–ª–∫–∞ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π!"
    exit 1
fi

echo "‚úÖ –ó–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ"
echo ""

# –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø–∞–ø–∫–∏ –¥–ª—è –ª–æ–≥—ñ–≤
mkdir -p logs

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ë–î
if [ ! -f "db.sqlite3" ]; then
    echo "üóÑÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–∏—Ö –±—É–¥–µ —Å—Ç–≤–æ—Ä–µ–Ω–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫—É"
fi

echo ""
echo "========================================"
echo "üöÄ –ó–∞–ø—É—Å–∫ –¥–æ–¥–∞—Ç–∫—ñ–≤..."
echo "========================================"
echo ""
echo "üì± Telegram –±–æ—Ç –∑–∞–ø—É—Å–∫–∞—î—Ç—å—Å—è..."
echo "üåê –í–µ–±-–¥–æ–¥–∞—Ç–æ–∫ –∑–∞–ø—É—Å–∫–∞—î—Ç—å—Å—è..."
echo ""
echo "üí° –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å Ctrl+C –¥–ª—è –∑—É–ø–∏–Ω–∫–∏"
echo "========================================"
echo ""

# –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –∑—É–ø–∏–Ω–∫–∏ –ø—Ä–æ—Ü–µ—Å—ñ–≤ –ø—Ä–∏ –≤–∏—Ö–æ–¥—ñ
cleanup() {
    echo ""
    echo "üõë –ó—É–ø–∏–Ω–∫–∞ –¥–æ–¥–∞—Ç–∫—ñ–≤..."
    kill $BOT_PID 2>/dev/null
    kill $WEB_PID 2>/dev/null
    echo "üëã –î–æ–¥–∞—Ç–∫–∏ –∑—É–ø–∏–Ω–µ–Ω–æ"
    exit 0
}

# –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –æ–±—Ä–æ–±–Ω–∏–∫–∞ —Å–∏–≥–Ω–∞–ª—É
trap cleanup INT TERM

# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ —É —Ñ–æ–Ω—ñ
python3 bot.py &
BOT_PID=$!
echo "üì± Telegram –±–æ—Ç –∑–∞–ø—É—â–µ–Ω–æ (PID: $BOT_PID)"

# –ó–∞–ø—É—Å–∫ –≤–µ–±-–¥–æ–¥–∞—Ç–∫—É —É —Ñ–æ–Ω—ñ
python3 webapp.py &
WEB_PID=$!
echo "üåê –í–µ–±-–¥–æ–¥–∞—Ç–æ–∫ –∑–∞–ø—É—â–µ–Ω–æ (PID: $WEB_PID)"

echo ""
echo "‚úÖ –î–æ–¥–∞—Ç–∫–∏ —É—Å–ø—ñ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω–æ!"
echo ""
echo "üì± Telegram –±–æ—Ç: –ø—Ä–∞—Ü—é—î"
echo "üåê –í–µ–±-–¥–æ–¥–∞—Ç–æ–∫: http://localhost:5000"
echo "üìã –õ–æ–≥–∏: logs/bot.log —Ç–∞ logs/webapp.log"
echo ""
echo "–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å Ctrl+C –¥–ª—è –∑—É–ø–∏–Ω–∫–∏..."
echo ""

# –û—á—ñ–∫—É–≤–∞–Ω–Ω—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –ø—Ä–æ—Ü–µ—Å—ñ–≤
wait